# .github/workflows/ci.yml
name: CI Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'

    - name: Build with Maven
      run: |
        cd cloud-services/customer-service
        mvn clean package
        
        cd ../points-service
        mvn clean package
        
        cd ../gateway
        mvn clean package

    - name: Run Tests
      run: |
        cd cloud-services/customer-service
        mvn test
        
        cd ../points-service
        mvn test
        
        cd ../gateway
        mvn test

    - name: Start DB2 Container
      run: |
        cd infrastructure/db
        docker-compose up -d
        
        # Wait for DB2 to be ready
        sleep 120
        
        # Verify DB2 connection
        docker exec db2-container db2cli validate -database "sample" -user db2inst1 -password password

    - name: Deploy to Docker
      run: |
        cd infrastructure
        docker-compose up -d
        
        # Wait for all services to be ready
        sleep 120
        
        # Test the API
        curl -s http://localhost:8081/api/customers | grep "[]"

    - name: Cleanup
      run: |
        cd infrastructure
        docker-compose down